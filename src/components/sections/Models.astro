---
/**
 * Models Section - Sección de Nuestros Modelos
 *
 * Estructura:
 * - SectionCard como contenedor
 * - Carrusel horizontal en móvil, grid 3 cols en desktop
 * - Modal de detalle extraído a ModelDetailModal.astro
 * - Lógica JS extraída a src/scripts/model-detail.ts
 */

import SectionCard from '../ui/SectionCard.astro';
import ModelCard from '../ui/ModelCard.astro';
import ModelDetailModal from '../ui/ModelDetailModal.astro';
import Button from '../ui/Button.astro';
import { getImage } from 'astro:assets';

// Importar imágenes para optimización
import imgCantabria from '../../assets/img/model-cantabria.jpg';
import imgValencia from '../../assets/img/model-valencia.jpg';
import imgAndalucia from '../../assets/img/model-andalucia.jpg';

// Pre-optimizar imágenes para el JS del detalle
const optimizedCantabria = await getImage({ src: imgCantabria, format: 'webp', width: 800 });
const optimizedValencia = await getImage({ src: imgValencia, format: 'webp', width: 800 });
const optimizedAndalucia = await getImage({ src: imgAndalucia, format: 'webp', width: 800 });

// Datos de modelos - Single Source of Truth
const MODELS = {
  cantabria: {
    title: 'Cantabria',
    subtitle: 'Lámina de Control Solar Residencial',
    badge: 'Top Ventas',
    price: '45€',
    desc: 'El modelo Cantabria representa el pináculo de la ingeniería en films solares residenciales. Ofrece el equilibrio perfecto entre luminosidad natural y protección térmica avanzada. Diseñada específicamente para hogares con exposición solar directa, esta lámina reduce drásticamente la carga térmica sin oscurecer sus estancias, manteniendo el confort visual y protegiendo mobiliario delicado.',
    specs: { heat: '65%', uv: '99%', light: '35%' },
    features: [
      { icon: 'zap', title: 'Ahorro Energético', desc: 'Reduce costes de climatización' },
      { icon: 'shield', title: 'Privacidad', desc: 'Visión unidireccional diurna' },
      { icon: 'armchair', title: 'Protección Muebles', desc: 'Evita la decoloración solar' }
    ],
    image: optimizedCantabria.src
  },
  valencia: {
    title: 'Valencia',
    subtitle: 'Equilibrio Solar Avanzado',
    price: '42€',
    desc: 'Un equilibrio perfecto entre protección y luminosidad. Ofrece un nivel intermedio de privacidad con una reducción de luz más notable, ideal para zonas con alta incidencia solar. Mantiene la claridad visual mientras bloquea eficazmente el calor excesivo.',
    specs: { heat: '75%', uv: '99%', light: '25%' },
    features: [
      { icon: 'thermometer-sun', title: 'Confort Térmico', desc: 'Ideal para zonas soleadas' },
      { icon: 'eye', title: 'Visión Clara', desc: 'Baja reflectividad interior' },
      { icon: 'sun', title: 'Control Solar', desc: 'Reducción significativa de calor' }
    ],
    image: optimizedValencia.src
  },
  andalucia: {
    title: 'Andalucía',
    subtitle: 'Máxima Protección Solar',
    price: '48€',
    desc: 'Nuestra opción más potente para condiciones extremas. Proporciona privacidad total y un rechazo de calor superior. Ideal para estancias muy expuestas, áticos, oficinas o escaparates comerciales que requieren máxima protección.',
    specs: { heat: '85%', uv: '99%', light: '15%' },
    features: [
      { icon: 'shield-check', title: 'Privacidad Total', desc: 'Máxima intimidad día y noche' },
      { icon: 'flame', title: 'Anti-Calor', desc: 'Rechazo térmico extremo' },
      { icon: 'lock', title: 'Seguridad', desc: 'Protección contra roturas' }
    ],
    image: optimizedAndalucia.src
  }
};
---

<section id="models-section" class="w-full">
  <SectionCard id="models-card" subtitle="Explora las opciones disponibles">

    <!-- Header: Título (estado 1) / Botón Volver (estado 2) -->
    <span slot="title" id="header-main">Nuestros Modelos</span>

    <!-- Navegación Detalle (oculto por defecto) -->
    <div slot="actions" id="header-detail-nav" class="hidden">
      <Button
        id="btn-back-models"
        variant="ghost"
        size="sm"
        iconLeft="arrow-left"
        aria-label="Volver al listado de modelos"
      >
        Volver
      </Button>
    </div>

    <!-- Vista Lista: Carrusel (full-bleed) -->
    <div
      id="models-list-view"
      class="-mx-4 lg:-mx-8 flex gap-4 overflow-x-auto px-4 lg:px-8 scrollbar-hide snap-x
             md:grid md:grid-cols-3 md:overflow-visible lg:gap-8"
    >
        <ModelCard
          slug="cantabria"
          title="Cantabria"
          subtitle="Privacidad + Luz"
          image={import('../../assets/img/model-cantabria.jpg')}
          badge="Top Ventas"
          class="w-[75vw] max-w-[280px] md:w-full md:max-w-none"
        />
        <ModelCard
          slug="valencia"
          title="Valencia"
          subtitle="Equilibrio Solar"
          image={import('../../assets/img/model-valencia.jpg')}
          class="w-[75vw] max-w-[280px] md:w-full md:max-w-none"
        />
        <ModelCard
          slug="andalucia"
          title="Andalucía"
          subtitle="Máxima Protección"
          image={import('../../assets/img/model-andalucia.jpg')}
          class="w-[75vw] max-w-[280px] md:w-full md:max-w-none"
        />
    </div>

    <!-- Vista Detalle: Modal -->
    <ModelDetailModal models={MODELS} />

  </SectionCard>
</section>

<script is:inline define:vars={{ MODELS }}>
(function() {
  // Prevenir doble inicialización
  if (window.__modelsScriptInitialized) return;
  window.__modelsScriptInitialized = true;

  // Referencias DOM
  const listView = document.getElementById('models-list-view');
  const detailView = document.getElementById('models-detail-view');
  const headerMain = document.getElementById('header-main');
  const headerDetail = document.getElementById('header-detail-nav');
  const modalDialog = detailView?.querySelector('[role="dialog"]');

  let triggerElement = null;
  let resizeObserver = null;
  let focusableElements = [];
  let firstFocusable = null;
  let lastFocusable = null;

  // ==================== UTILIDADES ====================

  function setText(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  }

  function getFocusableElements(container) {
    if (!container) return [];
    const selectors = 'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
    return Array.from(container.querySelectorAll(selectors));
  }

  // ==================== FOCUS TRAP ====================

  function setupFocusTrap() {
    if (!modalDialog) return;

    focusableElements = getFocusableElements(modalDialog);
    firstFocusable = focusableElements[0];
    lastFocusable = focusableElements[focusableElements.length - 1];
  }

  function handleFocusTrap(e) {
    if (!detailView || detailView.classList.contains('hidden')) return;

    if (e.key !== 'Tab') return;

    // Si no hay elementos focusables, prevenir navegación
    if (!firstFocusable) {
      e.preventDefault();
      return;
    }

    // Tab + Shift: ir hacia atrás
    if (e.shiftKey) {
      if (document.activeElement === firstFocusable) {
        e.preventDefault();
        lastFocusable?.focus();
      }
    }
    // Tab solo: ir hacia adelante
    else {
      if (document.activeElement === lastFocusable) {
        e.preventDefault();
        firstFocusable?.focus();
      }
    }
  }

  // ==================== SCROLL MANAGEMENT ====================

  function setupScrollManagement() {
    // Usar ResizeObserver para prevenir scroll issues
    if (modalDialog && typeof ResizeObserver !== 'undefined') {
      resizeObserver = new ResizeObserver(() => {
        if (!detailView?.classList.contains('hidden')) {
          // Fix para 100vw con scrollbar: calcular con el viewport real
          const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
          document.body.style.paddingRight = `${scrollbarWidth}px`;
        }
      });
      resizeObserver.observe(modalDialog);
    }
  }

  function cleanupScrollManagement() {
    if (resizeObserver) {
      resizeObserver.disconnect();
      resizeObserver = null;
    }
    document.body.style.paddingRight = '';
  }

  // ==================== MODAL ACTIONS ====================

  function openDetail(key, trigger) {
    const data = MODELS[key];
    if (!data) return;

    triggerElement = trigger || null;

    // Imagen
    const img = document.getElementById('detail-img');
    if (img) {
      img.src = data.image;
      img.alt = data.title;
    }

    // Textos
    setText('detail-title', data.title);
    setText('detail-subtitle', data.subtitle);
    setText('detail-desc', data.desc);
    setText('spec-heat', data.specs.heat);
    setText('spec-uv', data.specs.uv);
    setText('spec-light', data.specs.light);
    setText('detail-price', data.price);

    // Badge
    const badge = document.getElementById('detail-badge');
    if (badge) {
      if (data.badge) {
        badge.textContent = data.badge;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // Features
    document.querySelectorAll('[data-model-features]').forEach(el => el.classList.add('hidden'));
    document.querySelector(`[data-model-features="${key}"]`)?.classList.remove('hidden');

    // Toggle vistas
    listView?.classList.add('hidden');
    detailView?.classList.remove('hidden');
    headerMain?.classList.add('hidden');
    headerDetail?.classList.remove('hidden');

    // Lock scroll con fix para scrollbar
    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
    document.body.style.overflow = 'hidden';
    document.body.style.paddingRight = `${scrollbarWidth}px`;

    // Setup focus trap
    setupFocusTrap();

    // Focus en el primer elemento interactivo
    requestAnimationFrame(() => {
      firstFocusable?.focus();
    });
  }

  function closeDetail() {
    detailView?.classList.add('hidden');
    listView?.classList.remove('hidden');
    headerDetail?.classList.add('hidden');
    headerMain?.classList.remove('hidden');

    // Unlock scroll
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';

    // Restore focus
    triggerElement?.focus();
    triggerElement = null;

    // Reset focus trap
    focusableElements = [];
    firstFocusable = null;
    lastFocusable = null;
  }

  function goToCalculator() {
    closeDetail();
    setTimeout(() => {
      const wizardSection = document.getElementById('hero-wizard-section');
      wizardSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }

  // ==================== EVENT LISTENERS ====================

  function attachEventListeners() {
    // Tarjetas del carrusel
    document.querySelectorAll('.model-card-trigger').forEach(btn => {
      btn.addEventListener('click', () => openDetail(btn.dataset.model, btn));
    });

    // Botones cerrar
    document.getElementById('btn-back-models')?.addEventListener('click', closeDetail);
    document.getElementById('btn-back-internal')?.addEventListener('click', closeDetail);
    document.getElementById('btn-x-internal')?.addEventListener('click', closeDetail);
    document.getElementById('btn-add-budget-internal')?.addEventListener('click', goToCalculator);

    // Click en backdrop
    detailView?.querySelector('.fixed')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeDetail();
    });

    // ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !detailView?.classList.contains('hidden')) {
        closeDetail();
      }
    });

    // Focus trap
    document.addEventListener('keydown', handleFocusTrap);
  }

  // ==================== INITIALIZATION ====================

  function init() {
    attachEventListeners();
    setupScrollManagement();
  }

  function cleanup() {
    cleanupScrollManagement();
    window.__modelsScriptInitialized = false;
  }

  // Auto-init
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Astro View Transitions support
  document.addEventListener('astro:page-load', init);
  document.addEventListener('astro:before-preparation', cleanup);
})();
</script>
