---
// src/components/Wizard.astro
import Button from '../ui/Button.astro';
import IconBox from '../ui/IconBox.astro';
import BaseCard from '../ui/BaseCard.astro';
import SelectorCard from '../ui/SelectorCard.astro';

interface Props {
  prefix?: string;
  class?: string;
}

const { prefix = 'hero', class: className } = Astro.props;
---

<section id={`${prefix}-wizard-section`} class:list={["wizard-section", className]}>
    <div id={`${prefix}-wizard-announcer`} class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <div id={`${prefix}-wizard-container`} class="wizard-container bg-gradient-brand text-white rounded-2xl p-6 shadow-2xl ring-1 ring-white/10" role="group" aria-labelledby={`${prefix}-wizard-title`}>

        <div id={`${prefix}-step-1`} data-wizard-step="1" class="calc-step relative z-10 w-full animate-fade-in text-center">

            <div class="wizard-step-tag mx-auto mb-4">Presupuesto en 1 min</div>
            <h2 id={`${prefix}-wizard-title`} class="text-white mb-4">Calcula tu<br>Presupuesto</h2>

            <nav id={`${prefix}-wizard-breadcrumb`} data-wizard-breadcrumb class="flex justify-center gap-2 mb-6" aria-label="Progreso del formulario">
                <button class="breadcrumb-step active" data-step="1" aria-current="step">
                    <span class="breadcrumb-dot"></span>
                    <span class="breadcrumb-label">Ubicaci칩n</span>
                </button>
                <div class="breadcrumb-line"></div>
                <button class="breadcrumb-step" data-step="2" disabled>
                    <span class="breadcrumb-dot"></span>
                    <span class="breadcrumb-label">Ventanas</span>
                </button>
                <div class="breadcrumb-line"></div>
                <button class="breadcrumb-step" data-step="3" disabled>
                    <span class="breadcrumb-dot"></span>
                    <span class="breadcrumb-label">Modelo</span>
                </button>
                <div class="breadcrumb-line"></div>
                <button class="breadcrumb-step" data-step="4" disabled>
                    <span class="breadcrumb-dot"></span>
                    <span class="breadcrumb-label">Contacto</span>
                </button>
            </nav>

            <p class="text-base text-white/80 font-medium mb-6">Dinos d칩nde instalar칤amos para empezar:</p>

            <div class="space-y-4 mb-4">
                <div class="relative mb-3 group">
                    <div class="input-group-icon"><i data-lucide="map" class="w-5 h-5"></i></div>
                    <select id={`${prefix}-province`} aria-label="Selecciona tu provincia" class="form-input input-with-icon pl-11 cursor-pointer appearance-none">
                        <option value="" disabled selected>Selecciona tu Provincia...</option>
                        </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-azure-400">
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </div>
                </div>

                <div id={`${prefix}-group-municipality`} class="relative mb-3 hidden opacity-0 transition-opacity duration-500">
                    <div class="input-group-icon"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                    <input type="text" id={`${prefix}-municipality`} aria-label="Introduce tu municipio" placeholder="Municipio / Localidad" class="form-input input-with-icon pl-11">
                </div>
            </div>

            <button id={`${prefix}-btn-step-1`} class="btn-primary-dark w-full justify-center" data-action="next-step" disabled>
                <span>Siguiente</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>

        <div id={`${prefix}-step-2`} data-wizard-step="2" class="calc-step hidden relative z-10 w-full animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <Button
                    variant="ghost-white"
                    size="sm"
                    iconLeft="arrow-left"
                    uppercase
                    data-action="prev-step"
                    aria-label="Volver al paso anterior"
                >
                    Atr치s
                </Button>
                <div class="px-3 py-1 rounded-full bg-white/10 border border-white/20 text-white text-xs font-bold uppercase tracking-wider backdrop-blur-md">
                    Paso 2 de 4
                </div>
            </div>

            <h3 class="text-3xl text-white font-bold mb-1">쯈u칠 ventanas tienes?</h3>
            <p class="text-white/60 mb-6 text-lg">Selecciona la cantidad por tipo.</p>

            <div class="space-y-3 mb-4">
                <SelectorCard
                    icon="door-open"
                    title="Grande"
                    subtitle="Balc칩n / Ventanal"
                    windowType="grande"
                    counterId={`${prefix}-count-grande`}
                    class="selector-card"
                />
                <SelectorCard
                    icon="maximize"
                    title="Mediana"
                    subtitle="Normal / Est치ndar"
                    windowType="mediana"
                    counterId={`${prefix}-count-mediana`}
                    class="selector-card"
                />
                <SelectorCard
                    icon="minimize"
                    title="Peque침a"
                    subtitle="Ba침o / Cocina"
                    windowType="pequena"
                    counterId={`${prefix}-count-pequena`}
                    class="selector-card"
                />
                <SelectorCard
                    icon="plus"
                    title="Otro"
                    subtitle="Formas raras"
                    windowType="otro"
                    counterId={`${prefix}-count-otro`}
                    class="selector-card"
                />
            </div>

            <button id={`${prefix}-btn-step-2`} class="btn-primary-dark w-full justify-center btn-disabled" data-action="next-step" disabled>
                <span>Siguiente</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>

        <div id={`${prefix}-step-3`} data-wizard-step="3" class="calc-step hidden relative z-10 w-full animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <Button
                    variant="ghost-white"
                    size="sm"
                    iconLeft="arrow-left"
                    uppercase
                    data-action="prev-step"
                    aria-label="Volver al paso anterior"
                >
                    Atr치s
                </Button>
                <div class="px-3 py-1 rounded-full bg-white/10 border border-white/20 text-white text-xs font-bold uppercase tracking-wider backdrop-blur-md">
                    Paso 3 de 4
                </div>
            </div>

            <h3 class="text-xl text-white text-left font-bold mb-6">Elige tu Vinilo ideal:</h3>

            <div class="space-y-3 text-left mb-4">
                <BaseCard
                    as="div"
                    variant="white"
                    padding="sm"
                    radius="lg"
                    class="calc-model-card cursor-pointer border-2 transition-all active:scale-[0.98] duration-200 group"
                    data-model="cantabria"
                    role="button"
                    tabindex="0"
                >
                    <div class="flex items-start gap-4">
                        <IconBox icon="sun" size="lg" variant="brand" class="shrink-0 shadow-sm" />
                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="font-bold text-sm">Modelo Cantabria</h4>
                                <span class="badge badge--accent badge--xs">Top</span>
                            </div>
                            <p class="text-xs text-azure-500 leading-tight mt-1">Privacidad + Luz natural.</p>
                        </div>
                    </div>
                    <div class="check-icon absolute top-3 right-3 text-brand-600 opacity-0 scale-50 transition-all">
                        <i data-lucide="check-circle-2" class="w-5 h-5 fill-current"></i>
                    </div>
                </BaseCard>

                <BaseCard
                    as="div"
                    variant="white"
                    padding="sm"
                    radius="lg"
                    class="calc-model-card cursor-pointer border-2 transition-all active:scale-[0.98] duration-200 group"
                    data-model="valencia"
                    role="button"
                    tabindex="0"
                >
                    <div class="flex items-start gap-4">
                        <IconBox icon="scale" size="lg" variant="orange" class="shrink-0 shadow-sm" />
                        <div>
                            <h4 class="font-bold text-sm">Modelo Valencia</h4>
                            <p class="text-xs text-azure-500 leading-tight mt-1">Equilibrio calor / luz.</p>
                        </div>
                    </div>
                    <div class="check-icon absolute top-3 right-3 text-brand-600 opacity-0 scale-50 transition-all">
                        <i data-lucide="check-circle-2" class="w-5 h-5 fill-current"></i>
                    </div>
                </BaseCard>

                <BaseCard
                    as="div"
                    variant="white"
                    padding="sm"
                    radius="lg"
                    class="calc-model-card cursor-pointer border-2 transition-all active:scale-[0.98] duration-200 group"
                    data-model="andalucia"
                    role="button"
                    tabindex="0"
                >
                    <div class="flex items-start gap-4">
                        <IconBox icon="shield" size="lg" variant="azure" class="shrink-0 shadow-sm" />
                        <div>
                            <h4 class="font-bold text-sm">Modelo Andaluc칤a</h4>
                            <p class="text-xs text-azure-500 leading-tight mt-1">M치xima protecci칩n.</p>
                        </div>
                    </div>
                    <div class="check-icon absolute top-3 right-3 text-brand-600 opacity-0 scale-50 transition-all">
                        <i data-lucide="check-circle-2" class="w-5 h-5 fill-current"></i>
                    </div>
                </BaseCard>
            </div>

            <button id={`${prefix}-btn-step-3`} class="btn-primary-dark w-full justify-center" data-action="next-step" disabled>
                <span>Siguiente</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>

        <div id={`${prefix}-step-4`} data-wizard-step="4" class="calc-step hidden relative z-10 w-full animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <Button
                    variant="ghost-white"
                    size="sm"
                    iconLeft="arrow-left"
                    uppercase
                    data-action="prev-step"
                    aria-label="Volver al paso anterior"
                >
                    Atr치s
                </Button>
                <div class="px-3 py-1 rounded-full bg-white/10 border border-white/20 text-white text-xs font-bold uppercase tracking-wider backdrop-blur-md">
                    Paso 4 de 4
                </div>
            </div>

            <h3 class="wizard-title-message text-xl font-bold leading-snug mb-6">
                Te contactamos en menos de 24h y calculamos el coste sin compromiso
            </h3>

            <div class="space-y-4 text-left mb-4">
                <div class="relative group">
                    <div class="input-group-icon"><i data-lucide="user" class="w-5 h-5"></i></div>
                    <input type="text" id={`${prefix}-name`} aria-label="Nombre completo" placeholder="Tu Nombre" class="form-input input-with-icon pl-11">
                </div>
                <div class="input-group flex items-stretch overflow-hidden p-0 rounded-xl bg-white">
                    <div class="relative flex-shrink-0">
                        <select id={`${prefix}-prefix`} class="h-full bg-azure-50 border-r border-azure-100 text-azure-900 text-sm font-bold focus:ring-0 cursor-pointer pl-3 pr-8 appearance-none outline-none hover:bg-azure-100 transition-colors">
                            <option value="+34">游쀯릖 +34</option>
                            <option value="+33">游游 +33</option>
                            <option value="+351">游왫릖 +351</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none text-azure-500">
                            <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </div>
                    </div>
                    <input type="tel" id={`${prefix}-phone`} aria-label="N칰mero de tel칠fono" placeholder="600 000 000" class="form-input border-0 shadow-none pl-3 focus:ring-0 rounded-none h-auto py-3 flex-1">
                </div>
            </div>

            <button id={`${prefix}-btn-submit-whatsapp`} class="btn-whatsapp w-full">
                <svg class="w-5 h-5 fill-current"><use href="#icon-whatsapp"/></svg>
                <span>Ver Presupuesto</span>
            </button>

            <div class="mt-4 flex justify-center items-center gap-2 text-[10px] text-white opacity-80">
                <i data-lucide="lock" class="w-3 h-3"></i>
                <span class="font-medium">Tus datos est치n 100% seguros</span>
            </div>
        </div>

    </div>
</section>

<script is:inline type="module" define:vars={{ prefix }}>
    // Importamos la clase desde la carpeta p칰blica
    import '/assets/js/components/Wizard.js';

    // Funci칩n para inicializar
    function initWizard() {
        if (typeof window.Wizard !== 'undefined') {
            // Inicializar solo si existe el contenedor
            const containerId = `${prefix}-wizard-container`;
            const container = document.getElementById(containerId);
            
            if (container) {
                // Instanciar la clase con el prefijo
                new window.Wizard({
                    containerId: containerId,
                    prefix: prefix, // Pasamos el prefijo din치mico
                    provincesUrl: '/assets/data/provinces.json',
                    whatsapp: {
                        phone: '34600000000',
                        baseUrl: 'https://wa.me/'
                    }
                });
                console.log(`Wizard (${prefix}) inicializado correctamente`);
            }
        }
    }

    // Ejecutar cuando el contenido carga (compatible con Astro View Transitions)
    document.addEventListener('DOMContentLoaded', initWizard);
    document.addEventListener('astro:page-load', initWizard);
</script>

<style>
    /* Estilos espec칤ficos del Wizard que antes estaban en global.css */
    
    .calc-model-card.selected {
        border-color: var(--brand-400);
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }

    .calc-model-card.selected .check-icon {
        opacity: 1;
        transform: scale(1);
    }
    
    /* Animaci칩n del check */
    :global(.animate-checkmark-pop) {
        animation: checkmarkPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes checkmarkPop {
        0% {
            opacity: 0;
            transform: scale(0.5);
        }
        100% {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>
